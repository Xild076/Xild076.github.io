<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Programming - Entity Sentiment Targeting | Harry Yin&#39;s Portfolio</title>
    <meta name="description" content="A showcase of my projects and thoughts :D">
    <meta name="keywords" content="portfolio, projects, blog, developer">
    <meta name="author" content="Harry Yin">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://xild076.github.io/blog/sentiment_target.html">
    <meta property="og:title" content="Programming - Entity Sentiment Targeting | Harry Yin&#39;s Portfolio">
    <meta property="og:description" content="A showcase of my projects and thoughts :D">
    <meta property="og:image" content="">
    <meta property="og:site_name" content="Harry Yin&#39;s Portfolio">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://xild076.github.io/blog/sentiment_target.html">
    <meta property="twitter:title" content="Programming - Entity Sentiment Targeting | Harry Yin&#39;s Portfolio">
    <meta property="twitter:description" content="A showcase of my projects and thoughts :D">
    <meta property="twitter:image" content="">

    <link rel="icon" href="/static/img/favicon.ico" type="image/svg+xml">
    <link rel="stylesheet" href="/static/css/style.css">

    <script>
      (function() {
        const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

        <header class="site-header">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="site-title"><a href="/index.html">Harry Yin&#x27;s Portfolio</a></div>
    <nav class="justify-content-center nav-main"  style="margin-top: 0; margin-bottom: 0"><ul class="nav"><li class="nav-item"><a class="nav-link " href="/index.html">Home</a></li><li class="nav-item"><a class="nav-link " href="/projects.html">Projects</a></li><li class="nav-item"><a class="nav-link " href="/blog.html">Blog</a></li><li class="nav-item"><a class="nav-link " href="/cool_stuff.html">Cool Stuff</a></li><li class="nav-item"><a class="nav-link " href="/about.html">About</a></li></ul></nav>
    <button id="theme-toggle" title="Toggle theme" class="">ðŸŒ“</button>
  </div>
</header>

    <main id="main-content" role="main">
<div class="container py-lg"  style="margin-bottom: var(--spacing-md)"><p class="h1 mb-lg text-center text-left"  style="margin-bottom: var(--spacing-md); font-size: 3.5rem" data-scroll-animation="fade-in-down">Programming - Entity Sentiment Targeting</p><div class="align-items-start blog-post-meta d-flex flex-row flex-wrap justify-content-center mb-md text-muted"  style="margin-top: var(--spacing-sm); margin-bottom: 0"><p class="meta-item text-left"  style="margin-top: 0; margin-bottom: 0; color: var(--bs-gray-600)">By Harry Yin</p><p class="meta-separator mx-sm text-left"  style="margin-top: 0; margin-bottom: 0; color: var(--bs-gray-600)">â€¢</p><p class="meta-item text-left"  style="margin-top: 0; margin-bottom: 0; color: var(--bs-gray-600)">Published on 2025-04-04</p><p class="meta-separator mx-sm text-left"  style="margin-top: 0; margin-bottom: 0; color: var(--bs-gray-600)">â€¢</p><p class="meta-item text-left"  style="margin-top: 0; margin-bottom: 0; color: var(--bs-gray-600)">36 min read</p></div><hr class="divider" style="margin-top: var(--spacing-lg); margin-bottom: var(--spacing-lg); border: 0; border-top-width: 1px; border-top-style: solid; border-top-color: var(--bs-border-color); height: 0; opacity: 0.25"><div class="markdown-content"  style="margin-bottom: var(--spacing-md)"><p>This notebook aims to understand how sentiment is aimed at named entities</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">spacy</span> <span class="kn">import</span> <span class="n">displacy</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;en_core_web_sm&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">analyze_text_structures</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dep&quot;</span><span class="p">,</span> <span class="s2">&quot;ent&quot;</span><span class="p">]):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre>
</div>

<p>Let's first consider transitive verbs constructions.</p>

<p>This text will serve as an example:</p>

<p>"Adam criticized John's horrible decisions."</p>

<p>Adam will have a netural/positive sentiment because Adam acted negatively upon the "horrible decision", which would turn positive.
John will have a negative sentiment as John is associated with "horrible decisions".</p>

<p>Now, let's check out how the dependancies work.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;Adam criticized John&#39;s horrible decisions.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>Alright, so we have the following results.</p>

<p>The easy thing is finding the association between John and the negative sentiment. The primary source of negative sentiment comes from the term "horrible decisions", and since John associated with this negativity, then John is negative. However, since Adam is the subject criticizing Adam, then Adam is seen in a more positive light.</p>

<p>We can map this interaction out like this:</p>

<p>Subject Entity or Associated Entity (in this case nsubj) -> Verb -> Object Entity or Associated Entity (in this case dobj + poss)</p>

<p>However, for future reference, we can simply refer to this as Actor Clause -> Action -> Victim Clause.</p>

<p>Given that, the pattern I observe is so far is that:</p>

<p>Subj -> Positive Verb -> Obj (Negative Sentiment) = Negative Sentiment towards Subj
Subj -> Negative Verb -> Obj (Negative Sentiment) = Positive Sentiment towards Subj
Subj -> Positive Verb -> Obj (Positive Sentiment) = Positive Sentiment towards Subj
Subj -> Negative Verb -> Obj (Positive Sentiment) = Negative Sentiment towards Subj</p>

<p>Given all this, let's check out how the numbers would play out. For this analysis, I will be using VADER sentiment analysis.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn">vaderSentiment.vaderSentiment</span> <span class="kn">import</span> <span class="n">SentimentIntensityAnalyzer</span>
<span class="n">sia</span> <span class="o">=</span> <span class="n">SentimentIntensityAnalyzer</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam criticized John&#39;s horrible decisions.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam criticized&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;John&#39;s horrible decisions.&quot;</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>{'neg': 0.667, 'neu': 0.333, 'pos': 0.0, 'compound': -0.7184}
{'neg': 0.714, 'neu': 0.286, 'pos': 0.0, 'compound': -0.3612}
{'neg': 0.636, 'neu': 0.364, 'pos': 0.0, 'compound': -0.5423}
</code></pre>

<p>From this, we can see two key things. First, the sentiment associated with John would be about -0.5423. However, what would the sentiment associated with Adam be?</p>

<p>While this may seem arbritrary, I simply multiplied the two together (as the sentiment patterns fit surprisingly well into math) to get a sentiment of about 0.19587876, or mildly positive.</p>

<p>However, there are still are two main conditions I don't understand: sentence structure and descriptive cases (descriptive voice means that "the sad person"â€”sad brings a negtive connotation but a positive verb towards the sad person would reflect well on the subject instead of negatively).</p>

<p>Given that, let's first look at the more straight-forward and possibly more difficult: sentence stucture. There are many different sentence structures, and determining the characters and their interactions is very difficult. However, we can boil it down to the very essentials to make things simpler: all we need to know is the actor and all associated clauses.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;John&#39;s horrible decisions were criticized by Adam.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;Adam ordered John to stop eating in a late-night hateful rant.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;While ranting hatefully, Adam ordered John to stop eating.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;Adam, a horrible person, ordered John to stop eating.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;John was ordered to stop eating by Adam in a late-night hateful rant.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;While ranting hatefully, John was ordered to stop eating by Adam.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>Alright, so what do we see here?</p>

<p>Surprisingly, the patterns are pretty simple! </p>

<p>First, in a passive voice scenario ("John's horrible decisions were criticized by Adam."): </p>

<ol>
<li>The Actor clause is Adam (pobj)</li>
<li>The Action is "were criticized by"</li>
<li>The Victim clause is John's horrible decisions (nsubjpass)</li>
</ol>

<p>Next, in an active voice complex sentence with a final prepositional phrase modifier ("Adam ordered John stop eating in a late-night hateful rant."):
This case is a little more special because we have the added on "in a late-night hateful rant". This can either belong to the actor clause or the victim clause, so let's take a look at another sentence to be sure.</p>

<p>This is the passive voice version of the sentence: "John was ordered to stop eating by Adam in a late-night hateful rant." In this case, it seems that "in a late-night hateful rant" is once again associated with Adam, implying that a final prepositional phrase modifier is more commonly associated with the active actor instead of the subject. </p>

<p>Thus, for both, we can determine that:</p>

<ol>
<li>The Actor clause is Adam (nsubj/pobj) and "in a late-night hateful rant" (prep)</li>
<li>The Action is "ordered"/"was ordered" and "to stop eating" (xcomp)</li>
<li>The Victim clause is "John" (dobj/nsubjpass)</li>
</ol>

<p>Now, let's look at a similar case but with "While ranting hatefully, John was ordered to stop eating by Adam." and "While ranting hatefully, Adam ordered John to stop eating."
For this one, the dependent clause (advcl) seems to always be associated with the nsubj in some way. </p>

<p>Thus, it can be determined that for the first sentence:</p>

<ol>
<li>The Actor clause is Adam (pobj)</li>
<li>The Action is "was ordered to stop eating"</li>
<li>The Victim clause is "While ranting hatefully" (advcl) and "John" (nsubjpass)</li>
</ol>

<p>Meanwhile, for the second sentence:</p>

<ol>
<li>The Actor clause is "While ranting hatefully" (advcl) and "Adam" (nsubj)</li>
<li>The Action is "ordered" and "to stop eating" (xcomp)</li>
<li>The Victim clause is "John"</li>
</ol>

<p>Finally, let's look at "Adam, a horrible person, ordered John to stop eating."
This one was actually way simpler than all the other ones as "a horrible person" was associated to Adam with appos. That means that we can easily determine that:</p>

<ol>
<li>The Actor clause is "Adam, a horrible person,"</li>
<li>The Action is "ordered" and "to stop eating" (xcomp)</li>
<li>The Victim clause is "John"</li>
</ol>

<p>Thus, we have the general rules:</p>

<ol>
<li>The Actor clause is the clause of the actor/perpetrator who performs the action
<ul>
<li>Associated information includes anything attached with advcl, poss, or prep</li>
<li>There are possibly more rules involved, just ones I haven't discovered yet</li>
</ul></li>
<li>The Action is the verb and associated information with xcomp.</li>
<li>The Victim clause is the clause of the victim/reviever who recieves the action
<ul>
<li>Associated information includes anything attached with advcl, or poss</li>
</ul></li>
<li>Any named entities within each of the clauses will be associated with the sentiment of the clauses as a whole.</li>
</ol>

<p>Now the curiosity comes in when we have to try to find sentiments. We established before that we have to multiply the sentiment of the Victim clause with the sentiment of the Actor + Action clauses. However, things became slightly more muddled since, with the advent of sentiment within the actor clause, we need to see how this affects the sentence as a whole.</p>

<p>Let's take a look at three cases.</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># John&#39;s horrible decisions were criticized by Adam.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam ordered John to stop eating in a late-night hateful rant.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam in a late-night hateful rant&quot;</span><span class="p">))</span> <span class="c1"># Actor clause</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam ordered in a late-night hateful rant&quot;</span><span class="p">))</span> <span class="c1"># Actor clause + Action</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam ordered to stop eating&quot;</span><span class="p">))</span> <span class="c1"># Actor clause subject + Action</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;John&quot;</span><span class="p">))</span> <span class="c1"># Victim clause</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># While ranting hatefully, John was ordered to stop eating by Adam.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;While ranting hatefully, John was ordered to stop eating by Adam.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;While ranting hatefully, John&quot;</span><span class="p">))</span> <span class="c1"># Victim clause</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam&quot;</span><span class="p">))</span> <span class="c1"># Actor clause</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;was ordered to stop eating by Adam.&quot;</span><span class="p">))</span> <span class="c1"># Actor clause + Action</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;was ordered to stop eating by Adam.&quot;</span><span class="p">))</span> <span class="c1"># Actor clause subject + Action</span>


<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Adam, a horrible person, ordered John to stop eating.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam, a horrible person, ordered John to stop eating.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam, a horrible person,&quot;</span><span class="p">))</span> <span class="c1"># Actor clause</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam, a horrible person, ordered&quot;</span><span class="p">))</span> <span class="c1"># Actor clause + Action</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;Adam ordered&quot;</span><span class="p">))</span> <span class="c1"># Actor clause subject + Action</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;John to stop eating.&quot;</span><span class="p">))</span> <span class="c1"># Victim clause</span>
</code></pre>
</div>

<pre><code>{'neg': 0.494, 'neu': 0.506, 'pos': 0.0, 'compound': -0.7783}
{'neg': 0.583, 'neu': 0.417, 'pos': 0.0, 'compound': -0.6808}
{'neg': 0.528, 'neu': 0.472, 'pos': 0.0, 'compound': -0.6808}
{'neg': 0.355, 'neu': 0.645, 'pos': 0.0, 'compound': -0.296}
{'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}

{'neg': 0.379, 'neu': 0.621, 'pos': 0.0, 'compound': -0.6705}
{'neg': 0.524, 'neu': 0.476, 'pos': 0.0, 'compound': -0.5106}
{'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}
{'neg': 0.268, 'neu': 0.732, 'pos': 0.0, 'compound': -0.296}
{'neg': 0.268, 'neu': 0.732, 'pos': 0.0, 'compound': -0.296}

{'neg': 0.449, 'neu': 0.551, 'pos': 0.0, 'compound': -0.6908}
{'neg': 0.538, 'neu': 0.462, 'pos': 0.0, 'compound': -0.5423}
{'neg': 0.467, 'neu': 0.533, 'pos': 0.0, 'compound': -0.5423}
{'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}
{'neg': 0.423, 'neu': 0.577, 'pos': 0.0, 'compound': -0.296}
</code></pre>

<p>Okay, we have some interesting numbers to play with.</p>

<p>Now, I split the the sentiments into 4 different types: Actor clause, Actor clause + Action, Actor clause subject + Action, and Victim clause. </p>

<p>The only three important ones are Actor clause, Actor clause subject + Action, and Victim clause.</p>

<p>The new one here is Actor clause subject + Action. Previously, I used Actor clause + Action, however, I realized that this meant that I couldn't get what the verb is actually implying, I decided to purely use the Actor clause subject with the action to determine the sentiment of the action. </p>

<p>So, we have the following information (using "Adam ordered John stop eating in a late-night hateful rant." as an example):</p>

<ul>
<li>The Actor clause ("Adam in a late-night hateful rant") -> -0.6808 (AC)</li>
<li>The Actor clause subject + action ("Adam ordered to stop eating") -> -0.296 (ACS+A)</li>
<li>The Victim clause ("John") -> 0.0 (VC)</li>
</ul>

<p>So, how do we calculate sentiment? First, let's get a sense of what sentiment we should feel towards each character. Adam should face a very negative sentiment while John face a positive one. So, how do we achieve that?</p>

<p>Well, going off of the previous one, to get the Actor clause sentiment, we would multiple the ACS+A with the VC to get 0.0 and average it with AC, but that seems odd, as aiming a negative sentiment at a neutral target would normally be considered a negative thing to do. However, let's just go with it for now. The results would come out to be a compound -0.3404 sentiment for AC.</p>

<p>Meanwhile, doing the opposite for the VC, the we would multiply ASC+A with AC to get a compound 0.1007584 sentiment for the VC. That seems pretty accurate.</p>

<p>Thus, we can derive the equation to calculate entity sentiment:</p>

<p>Compound A/VC Sentiment = (V/AC * ASC+A + A/VC) / 2</p>

<p>Pretty neat, pretty simple, though it does decrease the sentiment intensity. For now, we have a pretty simple way to semi-reliably calculate the sentiment aimed at an entity!</p>

<p>Now, though, let's list out and tackle the big three issues all at once.</p>

<ul>
<li>Descriptive (ex: happy, sad, tall, short) vs Evaluative (ex: horrible, bad, good, helpful) descriptors</li>
<li>Sentiment mitigation and neutral sentiment cases</li>
<li>VADER's failures.</li>
</ul>

<p>First, let's solve the easiest issue: Vader's failures. </p>

<p>The thing about Vader is that Vader:</p>

<ol>
<li>Fails to understand things like sarcasm</li>
<li>Has a massively limited wordbank and range (especially compared to newer tools)</li>
</ol>

<p>We can ignore the first issue as we aren't too worried about sarcasm right now since our focus is determining sentiment target rather than textual nuances.</p>

<p>However, the second issue is a pretty big problem. Just take a look at how it handles these sentences:</p>

<pre><code>
```python
print(sia.polarity_scores("Adam ordered."))
print(sia.polarity_scores("Adam had a freak-out."))
print(sia.polarity_scores("Adam did harmful things."))
</code></pre>

<pre><code>{'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}
{'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}
{'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}
</code></pre>

<p>Well... the first one makes sense but the other two are just ridiculous. "Harmful" and "freak-out" are definately negative.</p>

<p>Now, let's try to solve this! Solving this is pretty simpleâ€”let's just look at other tools instead and agregate a solution together! Let's use the same three examples.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>
<span class="kn">from</span> <span class="nn">afinn</span> <span class="kn">import</span> <span class="n">Afinn</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Textblob sentiment:&quot;</span><span class="p">,</span> <span class="n">TextBlob</span><span class="p">(</span><span class="s2">&quot;Adam ordered.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Textblob sentiment:&quot;</span><span class="p">,</span> <span class="n">TextBlob</span><span class="p">(</span><span class="s2">&quot;Adam had a freak-out.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Textblob sentiment:&quot;</span><span class="p">,</span> <span class="n">TextBlob</span><span class="p">(</span><span class="s2">&quot;Adam did harmful things.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>

<span class="n">afn</span> <span class="o">=</span> <span class="n">Afinn</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AFINN sentiment:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score_with_wordlist</span><span class="p">(</span><span class="s2">&quot;Adam ordered.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AFINN sentiment:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score_with_wordlist</span><span class="p">(</span><span class="s2">&quot;Adam had a freak-out.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AFINN sentiment:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score_with_wordlist</span><span class="p">(</span><span class="s2">&quot;Adam did harmful things.&quot;</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>Textblob sentiment: Sentiment(polarity=0.0, subjectivity=0.0)
Textblob sentiment: Sentiment(polarity=0.0, subjectivity=0.0)
Textblob sentiment: Sentiment(polarity=0.0, subjectivity=0.0)

AFINN sentiment: 0.0
AFINN sentiment: -2.0
AFINN sentiment: -2.0
</code></pre>

<p>Well... these results don't look good for textblob, though they look better for AFINN, which makes sense, since AFINN operates purely on the words in the sentences.</p>

<p>So, how do we aggregate these results? Once again, while this may be crude, I decided to normalize AFINN with the total number of words tested, dividing them over 5, and average them with the Vader scores.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">nltk</span>
<span class="n">afn</span> <span class="o">=</span> <span class="n">Afinn</span><span class="p">()</span>
<span class="n">sia</span> <span class="o">=</span> <span class="n">SentimentIntensityAnalyzer</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">normalized_afinn_score</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">word_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="n">relevant_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">word_scores</span> <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">relevant_scores</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">relevant_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_scores</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">get_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">afn_score</span> <span class="o">=</span> <span class="n">normalized_afinn_score</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">polarity_score</span> <span class="o">=</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;compound&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">afn_score</span> <span class="o">+</span> <span class="n">polarity_score</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="n">test_text</span> <span class="o">=</span> <span class="s2">&quot;Adam had a freak-out and did harmful things.&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aggregate sentiment:&quot;</span><span class="p">,</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">test_text</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AFINN sentiment:&quot;</span><span class="p">,</span> <span class="n">normalized_afinn_score</span><span class="p">(</span><span class="n">test_text</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polarity sentiment:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">test_text</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>Aggregate sentiment: -0.2
AFINN sentiment: -0.4
Polarity sentiment: {'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}
</code></pre>

<p>I'll be the first to admit that this is more than just "cobbled together", this is downright falling apart. But it's good enough for now, so let's move on to tacklign issue #2: sentiment mitigation and neutral sentiment cases.</p>

<p>Let's go back to the Adam example.</p>

<ul>
<li>The Actor clause ("Adam in a late-night hateful rant") -> -0.6808 (AC)</li>
<li>The Actor clause subject + action ("Adam ordered to stop eating") -> -0.296 (ACS+A)</li>
<li>The Victim clause ("John") -> 0.0 (VC)</li>
</ul>

<p>Given:
Compound A/VC Sentiment = (V/AC * ASC+A + A/VC) / 2,
as mentioned before, the sentiment multiplied together would be 0.0 * -0.6808 = 0, which makes no sense. After all, taking action against a neutral individual is still negative. Thus, I decided to modify the equation slightly to reflect this by giving an addative to the compount sentiments and by adding a 1/3 weighing ratio:</p>

<p>Compound A/VC Sentiment = ((V/AC + 1) * ASC+A + A/VC * 3) / 4, V/AC &gt;= 0
Compound A/VC Sentiment = ((V/AC - 1) * ASC+A + A/VC * 3) / 4, V/AC &lt; 0</p>

<p>I did this because: </p>

<ul>
<li>Adding/subtracting 1 would ensure that biases don't get unnecessarily mitigated</li>
<li>Putting them on a ratio ensures that independent sentiment, which usually leaves a higher impression, is put to greater effect.</li>
</ul>

<p>Now that is a bit better. Furthermore, this actually also solves the issue of sentiment mitigation as when before, the average would always decrease due to |V/AC| always being less than 1, now the average can increase as |V/AC| can be greater than 1. Let's put this into code.</p>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">calculate_compound_sentiment</span><span class="p">(</span><span class="n">base_sentiment</span><span class="p">,</span> <span class="n">other_sentiment</span><span class="p">,</span> <span class="n">action_sentiment</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">other_sentiment</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">compound_sentiment</span> <span class="o">=</span> <span class="p">((</span><span class="n">other_sentiment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">action_sentiment</span> <span class="o">+</span> <span class="n">base_sentiment</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compound_sentiment</span> <span class="o">=</span> <span class="p">((</span><span class="n">other_sentiment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">action_sentiment</span> <span class="o">+</span> <span class="n">base_sentiment</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="k">return</span> <span class="n">compound_sentiment</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Actor sentiment (Adam example):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="o">-</span><span class="mf">0.6808</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.296</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Victim sentiment (Adam example):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6808</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.296</span><span class="p">))</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Positive -&gt; positive -&gt; positive case</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Positive -&gt; positive -&gt; positive&quot;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;The kind man positively helped the nice children.&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="s2">&quot;The kind man&quot;</span>
<span class="n">asca</span> <span class="o">=</span> <span class="s2">&quot;positively helped&quot;</span>
<span class="n">vc</span> <span class="o">=</span> <span class="s2">&quot;the nice children&quot;</span>

<span class="n">ac_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
<span class="n">asca_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">asca</span><span class="p">)</span>
<span class="n">vc_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AC sentiment:&quot;</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ASCA sentiment:&quot;</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VC sentiment:&quot;</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Actor sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">ac_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Victim sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">vc_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">))</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Positive -&gt; positive -&gt; negative case</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Positive -&gt; positive -&gt; negative&quot;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;The kind man positively helped the evil villians.&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="s2">&quot;The kind man&quot;</span>
<span class="n">asca</span> <span class="o">=</span> <span class="s2">&quot;positively helped&quot;</span>
<span class="n">vc</span> <span class="o">=</span> <span class="s2">&quot;the evil villians&quot;</span>

<span class="n">ac_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
<span class="n">asca_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">asca</span><span class="p">)</span>
<span class="n">vc_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AC sentiment:&quot;</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ASCA sentiment:&quot;</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VC sentiment:&quot;</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Actor sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">ac_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Victim sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">vc_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">))</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Positive -&gt; positive -&gt; negative case</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Positive -&gt; negative -&gt; positive&quot;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;The kind man sucker punched the nice children.&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="s2">&quot;The kind man&quot;</span>
<span class="n">asca</span> <span class="o">=</span> <span class="s2">&quot;sucker punched&quot;</span>
<span class="n">vc</span> <span class="o">=</span> <span class="s2">&quot;the nice children&quot;</span>

<span class="n">ac_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
<span class="n">asca_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">asca</span><span class="p">)</span>
<span class="n">vc_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AC sentiment:&quot;</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ASCA sentiment:&quot;</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VC sentiment:&quot;</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Actor sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">ac_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Victim sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">vc_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">))</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Positive -&gt; negative -&gt; negative case</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Positive -&gt; negative -&gt; negative&quot;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;The kind man sucker punched the evil villians.&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="s2">&quot;The kind man&quot;</span>
<span class="n">asca</span> <span class="o">=</span> <span class="s2">&quot;sucker punched&quot;</span>
<span class="n">vc</span> <span class="o">=</span> <span class="s2">&quot;the evil villians&quot;</span>

<span class="n">ac_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
<span class="n">asca_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">asca</span><span class="p">)</span>
<span class="n">vc_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AC sentiment:&quot;</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ASCA sentiment:&quot;</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VC sentiment:&quot;</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Actor sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">ac_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Victim sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">vc_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">))</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Negative -&gt; negative -&gt; negative case</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Negative -&gt; negative -&gt; negative&quot;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;The evil warlord brutally murdered the cruel dictator.&quot;</span>
<span class="n">ac</span> <span class="o">=</span> <span class="s2">&quot;The evil warlord&quot;</span>
<span class="n">asca</span> <span class="o">=</span> <span class="s2">&quot;brutally murdered&quot;</span>
<span class="n">vc</span> <span class="o">=</span> <span class="s2">&quot;the cruel dictator&quot;</span>

<span class="n">ac_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
<span class="n">asca_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">asca</span><span class="p">)</span>
<span class="n">vc_s</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AC sentiment:&quot;</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ASCA sentiment:&quot;</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VC sentiment:&quot;</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Actor sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">ac_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">vc_s</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compound Victim sentiment (Random test):&quot;</span><span class="p">,</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">vc_s</span><span class="p">,</span> <span class="n">asca_s</span><span class="p">,</span> <span class="n">ac_s</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>Actor sentiment (Adam example): -0.5845999999999999
Victim sentiment (Adam example): 0.1243792

Positive -&gt; positive -&gt; positive
AC sentiment: 0.46335
ASCA sentiment: 0.46335
VC sentiment: 0.51075
Compound Actor sentiment (Random test): 0.534364003125
Compound Victim sentiment (Random test): 0.552573305625

Positive -&gt; positive -&gt; negative
AC sentiment: 0.46335
ASCA sentiment: 0.46335
VC sentiment: -0.62985
Compound Actor sentiment (Random test): 0.11708975062500002
Compound Victim sentiment (Random test): -0.30287669437500003

Positive -&gt; negative -&gt; positive
AC sentiment: 0.46335
ASCA sentiment: -0.26335
VC sentiment: 0.51075
Compound Actor sentiment (Random test): 0.18619849687499998
Compound Victim sentiment (Random test): 0.23671919437500002

Positive -&gt; negative -&gt; negative
AC sentiment: 0.46335
ASCA sentiment: -0.26335
VC sentiment: -0.62985
Compound Actor sentiment (Random test): 0.546442749375
Compound Victim sentiment (Random test): -0.618730805625

Negative -&gt; negative -&gt; negative
AC sentiment: -0.62985
ASCA sentiment: -0.72775
VC sentiment: -0.59295
Compound Actor sentiment (Random test): -0.21627015937500005
Compound Victim sentiment (Random test): -0.17265666562499998
</code></pre>

<p>And the results are pretty satisfactory, each example relatively accurately illustrate how the sentiment should play out.</p>

<p>Now, let's get to the final and (possibly) most difficult part: determining the difference between descriptive and evaluative words.</p>

<p>First, let's define the difference between descriptive and evaluative words. Descriptive words are primarily words that observe versus evaluative words being words that judge. This chart below contains a few examples:</p>

<table>
<thead>
<tr>
  <th>Descriptive</th>
  <th>Evaluative</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Tall, short, loud, quiet</td>
  <td>nice, bad, corrupt, amazing</td>
</tr>
</tbody>
</table>

<p>Now let's look at what the sentiment analyzers say about them!</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Descriptive:&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tall:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;tall&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;tall&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Short:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;short&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;short&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loud:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;loud&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;loud&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Quiet:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Evaluative&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nice:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;nice&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;nice&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Bad:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;bad&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;bad&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Corrupt:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;corrupt&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;corrupt&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Amazing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Afinn score:&quot;</span><span class="p">,</span> <span class="n">afn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s2">&quot;amazing&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vader score:&quot;</span><span class="p">,</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="s2">&quot;amazing&quot;</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>Descriptive:

Tall:
Afinn score: 0.0
Vader score: {'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}

Short:
Afinn score: 0.0
Vader score: {'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}

Loud:
Afinn score: 0.0
Vader score: {'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}

Quiet:
Afinn score: 0.0
Vader score: {'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}


Evaluative

Nice:
Afinn score: 3.0
Vader score: {'neg': 0.0, 'neu': 0.0, 'pos': 1.0, 'compound': 0.4215}

Bad:
Afinn score: -3.0
Vader score: {'neg': 1.0, 'neu': 0.0, 'pos': 0.0, 'compound': -0.5423}

Corrupt:
Afinn score: -3.0
Vader score: {'neg': 0.0, 'neu': 1.0, 'pos': 0.0, 'compound': 0.0}

Amazing:
Afinn score: 4.0
Vader score: {'neg': 0.0, 'neu': 0.0, 'pos': 1.0, 'compound': 0.5859}
</code></pre>

<p>Well... how surprising! It turns out: the perceived issue wasn't an issue at all! AFINN and Vader had it covered! That means that all three major issues in calculating sentiment have been completed.</p>

<p>However, we am not done yet! There are still two things we need to do:</p>

<p>First, remember how we split everything into: Actor Clause -> Action -> Victim Clause? Well, we need to figure out how to do that.</p>

<p>Secondly, we need to consider everything that doesn't fall under the category of transitive verbs constructions, which is basically just any sentence without a direct object. Getting sentiment for these types of sentences are pretty easy, but we need to be able to be able to locate independant clauses and the such to actually properly calculate sentiment.</p>

<p>That being said, let's get started with the first issue.</p>

<p>First, I had a quick look through all the sentences to extract the patterns and they ended up below.</p>

<p>Active Voice:</p>

<ul>
<li>Actor: nsubj and all subtrees</li>
<li>Action: Verb + xcomp (excluding prep subtrees)</li>
<li>Victim: dobj and all subtrees</li>
</ul>

<p>Passive Voice:</p>

<ul>
<li>Actor: pobj and all subtrees</li>
<li>Action: Verb + auxpass + agent</li>
<li>Victim: nsubjpass and all subtrees</li>
</ul>

<p>Active Voice + Final Prepositional Phrase Modifier:</p>

<ul>
<li>Actor: nsubj and all subtrees + prep</li>
<li>Action: Verb + xcomp (excluding prep subtrees)</li>
<li>Victim: dobj and all subtrees</li>
</ul>

<p>Active Voice (Complex Sentence):</p>

<ul>
<li>Actor: nsubj and all subtrees + advcl and all subtrees</li>
<li>Action: Verb + xcomp (excluding prep subtrees)</li>
<li>Victim: dobj and all subtrees</li>
</ul>

<p>Passive Voice + Final Prepositional Phrase Modifier:</p>

<ul>
<li>Actor: pobj and all subtrees + prep</li>
<li>Action: Verb + xcomp (excluding prep subtrees)</li>
<li>Victim: nsubjpass and all subtrees</li>
</ul>

<p>Passive Voice (Complex Sentence):</p>

<ul>
<li>Actor: dobj and all subtrees</li>
<li>Action: Verb + xcomp (excluding prep subtrees)</li>
<li>Victim: advcl + nsubjpass</li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">sent</span><span class="o">.</span><span class="n">root</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">sents</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">target_deps</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">in</span> <span class="n">target_deps</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">exclude_branch_types</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">subtree_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">traverse_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_branch_types</span><span class="p">:</span>
            <span class="n">subtree_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">traverse_subtree</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
    <span class="n">traverse_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subtree_tokens</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">target_dep</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="n">target_dep</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_named_entities_token</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">allowed_labels</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PERSON&quot;</span><span class="p">,</span> <span class="s2">&quot;ORG&quot;</span><span class="p">,</span> <span class="s2">&quot;GPE&quot;</span><span class="p">,</span> <span class="s2">&quot;NORP&quot;</span><span class="p">,</span> <span class="s2">&quot;FAC&quot;</span><span class="p">,</span> <span class="s2">&quot;PRODUCT&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT&quot;</span><span class="p">,</span> <span class="s2">&quot;LOC&quot;</span><span class="p">,</span> <span class="s2">&quot;WORK_OF_ART&quot;</span><span class="p">,</span> <span class="s2">&quot;LAW&quot;</span><span class="p">,</span> <span class="s2">&quot;LANGUAGE&quot;</span><span class="p">}</span>
    <span class="n">token_idxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">i</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">}</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">doc</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span> <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="ow">in</span> <span class="n">allowed_labels</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">i</span> <span class="ow">in</span> <span class="n">token_idxs</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ent</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">extract_named_entities</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">allowed_labels</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PERSON&quot;</span><span class="p">,</span> <span class="s2">&quot;ORG&quot;</span><span class="p">,</span> <span class="s2">&quot;GPE&quot;</span><span class="p">,</span> <span class="s2">&quot;NORP&quot;</span><span class="p">,</span> <span class="s2">&quot;FAC&quot;</span><span class="p">,</span> <span class="s2">&quot;PRODUCT&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT&quot;</span><span class="p">,</span> <span class="s2">&quot;LOC&quot;</span><span class="p">,</span> <span class="s2">&quot;WORK_OF_ART&quot;</span><span class="p">,</span> <span class="s2">&quot;LAW&quot;</span><span class="p">,</span> <span class="s2">&quot;LANGUAGE&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span> <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="ow">in</span> <span class="n">allowed_labels</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">split_into_independent_clauses</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">sents</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span>
        <span class="n">split_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">&quot;cc&quot;</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">sent</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                <span class="n">split_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">split_indices</span><span class="p">:</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sent</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">split_indices</span><span class="p">:</span>
                <span class="n">clause_tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">clause_tokens</span> <span class="ow">and</span> <span class="n">clause_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="s2">&quot;but&quot;</span><span class="p">}:</span>
                    <span class="n">clause_tokens</span> <span class="o">=</span> <span class="n">clause_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">clause_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">clause_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">clause_text</span><span class="p">:</span>
                    <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause_text</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">clause_tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">clause_tokens</span> <span class="ow">and</span> <span class="n">clause_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="s2">&quot;but&quot;</span><span class="p">}:</span>
                <span class="n">clause_tokens</span> <span class="o">=</span> <span class="n">clause_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">clause_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">clause_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">clause_text</span><span class="p">:</span>
                <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clauses</span>

<span class="k">def</span> <span class="nf">extract_ac_asca_vc</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;dobj&#39;</span><span class="p">):</span>
        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nsubj&#39;</span><span class="p">])</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_prep_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">ac_prep_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_advcl_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;advcl&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;advcl&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ac_advcl_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_advcl_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">ac_advcl_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="o">+</span> <span class="n">ac_advcl_base_subtree</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>

        <span class="n">a_base</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">a_base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;nsubj&quot;</span><span class="p">,</span> <span class="s2">&quot;dobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>

        <span class="n">asca_full</span> <span class="o">=</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">a_full</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>

        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dobj&#39;</span><span class="p">])</span>
        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dative&#39;</span><span class="p">])</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>

        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span>
    <span class="k">elif</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubjpass&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;pobj&#39;</span><span class="p">):</span>
        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pobj&#39;</span><span class="p">])</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">full_prep_tokens</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])</span>
        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">full_prep_tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_prep_tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">full_prep_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_prep_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">ac_prep_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_prep_tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ac_prep_base_subtree</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>

        <span class="n">a_base</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">a_base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;nsubjpass&quot;</span><span class="p">,</span> <span class="s2">&quot;pobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>

        <span class="n">asca_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">ac_base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">a_full</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>

        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nsubjpass&#39;</span><span class="p">])</span>
        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dative&#39;</span><span class="p">])</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>

        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span>
</code></pre>
</div>

<p>Given all of that, we have a basic rule-based method for transitive verbs constructions! Yay! Just as a disclaimer though: This is completely cobbled together and in no way accurate/proper. That being said, let's start testing.</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Test cases</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;Adam and Alice ordered John to stop eating in a late-night hateful rant.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;While ranting hatefully, Adam ordered John to stop eating.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;Adam, a horrible person, ordered John to stop eating.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;John was ordered to stop eating by Adam in a late-night hateful rant.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;While ranting hatefully, John was ordered to stop eating by Adam.&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Actual example texts from </span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;The best road trip in Boston history has given the Celtics a chance at grabbing a piece of NBA history.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;The waspâ€™s flaps and teeth-like hairs resemble the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects.&quot;</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>('Adam and Alice in a late - night hateful rant', 'ordered to stop eating .', 'Adam ordered to stop eating .', 'John', ['Adam', 'Alice'], ['John'])
('While ranting hatefully Adam', ', ordered to stop eating .', ', Adam ordered to stop eating .', 'John', ['Adam'], ['John'])
('Adam , a horrible person ,', 'ordered to stop eating .', 'Adam ordered to stop eating .', 'John', ['Adam'], ['John'])
('Adam in a late - night hateful rant', 'was ordered to stop eating .', 'was ordered to stop eating by Adam .', 'John', ['Adam'], ['John'])
('by Adam', ', was ordered to stop eating .', ', was ordered to stop eating by Adam .', 'John', ['Adam'], ['John'])

('The best road trip in in Boston Boston history history', 'has given .', 'trip has given .', 'the Celtics a chance at grabbing a piece of NBA history', ['Boston'], ['Celtics', 'NBA'])
('The wasp â€™s of the carnivorous Venus flytrap plant , which snaps shut to to digest digest unsuspecting unsuspecting insects insects', 'resemble .', 'wasp hairs resemble which snaps .', 'the structure of the carnivorous Venus flytrap plant , which snaps shut to digest unsuspecting insects', ['Venus'], ['Venus'])
</code></pre>

<p>Well, we have some successes and some failures, which is natural as the rule-based structure needs to be continuously updated, something of which I will continue to do later on. However, for now, it is generally satisfactory, though it fails real-world tests. That being said, let's get to the second issue: anything that doesn't fall under the category of transitive verbs constructions. The solution to this is very easyâ€”as there aren't two different verbs, sentiment can only be aimed at a single thing! So let's update some things real quick.</p>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract_ac_asca_vc</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;dobj&#39;</span><span class="p">):</span>
        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nsubj&#39;</span><span class="p">])</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_prep_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">ac_prep_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_advcl_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;advcl&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;advcl&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ac_advcl_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_advcl_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">ac_advcl_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="o">+</span> <span class="n">ac_advcl_base_subtree</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>

        <span class="n">a_base</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">a_base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;nsubj&quot;</span><span class="p">,</span> <span class="s2">&quot;dobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>

        <span class="n">asca_full</span> <span class="o">=</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">a_full</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>

        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dobj&#39;</span><span class="p">])</span>
        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dative&#39;</span><span class="p">])</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>

        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span><span class="p">)}</span>
    <span class="k">elif</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubjpass&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;pobj&#39;</span><span class="p">):</span>
        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pobj&#39;</span><span class="p">])</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">full_prep_tokens</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])</span>
        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">full_prep_tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_prep_tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">full_prep_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_prep_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">ac_prep_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_prep_tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ac_prep_base_subtree</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>

        <span class="n">a_base</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">a_base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;nsubjpass&quot;</span><span class="p">,</span> <span class="s2">&quot;pobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>

        <span class="n">asca_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">ac_base</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">a_full</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>

        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nsubjpass&#39;</span><span class="p">])</span>
        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dative&#39;</span><span class="p">])</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>

        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ntvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">extract_named_entities</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
</code></pre>
</div>

<p>Let's try this out.</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;Jerry was very upset and sad.&quot;</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>{'type': 'ntvc', 'output': ('Jerry was very upset and sad.', '', '', '', ['Jerry'], '')}
</code></pre>

<p>Yup, works as expected.</p>

<p>Thus, the barebones of the project is complete. We have a basic, heuristic, rule-based method to calculate enitty-targeted sentiment! Yay!</p>

<p>However, as always, this isn't perfect. The main thing we need to improve is the rule-based actor-action-victim extraction and everything will be set. But for now, let's get to refining.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;The best road trip in Boston history has given the Celtics a chance at grabbing a piece of NBA history.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">analyze_text_structures</span><span class="p">(</span><span class="s2">&quot;The waspâ€™s flaps and teeth-like hairs resemble the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects.&quot;</span><span class="p">,</span> <span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>For the first text, these should be the clauses:</p>

<ul>
<li>AC: "The best road trip in Boston history"</li>
<li>A: "has given"</li>
<li>VC: "the Celtics a chance at grabbing a piece of NBA history."</li>
</ul>

<p>For the second text, these should be the clauses:</p>

<ul>
<li>AC: "The waspâ€™s flaps and teeth-like hairs"</li>
<li>A: "resemble"</li>
<li>VC: "the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects."</li>
</ul>

<p>It seems, thus, the big issue within our code is that we don't go off of the root of the text. So let's try that out.</p>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_conjuncts</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">&quot;conj&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_conjuncts</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">allowed_deps</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">in</span> <span class="n">allowed_deps</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_conjuncts</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">allowed_deps</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">exclude_branch_types</span><span class="o">=</span><span class="p">[],</span> <span class="n">excluded_tokens</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">subtree_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">traverse_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">excluded_tokens</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_branch_types</span><span class="p">:</span>
            <span class="n">subtree_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">traverse_subtree</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
    <span class="n">traverse_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subtree_tokens</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_tokens_by_dependencies</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">target_deps</span><span class="p">,</span> <span class="n">excluded_tokens</span><span class="o">=</span><span class="p">[]):</span> 
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_deps</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">target_deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_deps</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">in</span> <span class="n">target_deps</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_tokens</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">dep_labels</span><span class="p">,</span> <span class="n">exclusion_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">dep_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_labels</span><span class="p">]</span>
    <span class="n">excluded_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">exclusion_list</span><span class="p">:</span>
        <span class="n">excluded_tokens</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">subtree</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="ow">in</span> <span class="n">dep_labels</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_tokens</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">extract_ac_asca_vc</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;dobj&#39;</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubj&quot;</span><span class="p">])</span>
        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dobj&quot;</span><span class="p">])</span>

        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_base</span><span class="p">:</span>
            <span class="n">ac_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base_subtree</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>

        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;prep&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_prep_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">ac_prep_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_advcl_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;advcl&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_advcl_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_advcl_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">ac_advcl_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="o">+</span> <span class="n">ac_advcl_base_subtree</span><span class="p">))</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>

        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubj&quot;</span><span class="p">,</span> <span class="s2">&quot;dobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">))</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>

        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base</span> <span class="o">+</span> <span class="n">a_full</span><span class="p">))</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>

        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_base</span><span class="p">:</span>
            <span class="n">vc_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dative&quot;</span><span class="p">],</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span><span class="p">))</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>

        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span><span class="p">)}</span>

    <span class="k">elif</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubjpass&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;pobj&#39;</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;pobj&quot;</span><span class="p">])</span>
        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubjpass&quot;</span><span class="p">])</span>

        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_base</span><span class="p">:</span>
            <span class="n">ac_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;prep&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_prep_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">ac_prep_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_advcl_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;advcl&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_advcl_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_advcl_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">ac_advcl_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="o">+</span> <span class="n">ac_advcl_base_subtree</span><span class="p">))</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>

        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubjpass&quot;</span><span class="p">,</span> <span class="s2">&quot;pobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">))</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>

        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base</span> <span class="o">+</span> <span class="n">a_full</span><span class="p">))</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>

        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dative&quot;</span><span class="p">],</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span><span class="p">))</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>

        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span><span class="p">)}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ntvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">extract_named_entities</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
</code></pre>
</div>

<p>Alright, now that it is updated, let's give it a test run.</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;The best road trip in Boston history has given the Celtics a chance at grabbing a piece of NBA history.&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="s2">&quot;The waspâ€™s flaps and teeth-like hairs resemble the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects.&quot;</span><span class="p">))</span>
</code></pre>
</div>

<pre><code>{'type': 'tvc', 'output': ('The best road trip in Boston history', 'has given .', 'trip has given .', 'the Celtics a chance at grabbing a piece of NBA history', ['Boston'], ['Celtics', 'NBA'])}
{'type': 'tvc', 'output': ('The wasp â€™s flaps and teeth - like hairs', 'resemble .', 'hairs resemble .', 'the structure of the carnivorous Venus flytrap plant , which snaps shut to digest unsuspecting insects', [], ['Venus'])}
</code></pre>

<p>Wow! The code actually works now! Good stuff. With that settled, let's put everything together into one, final, solid function to calculate sentiment.</p>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">calculate_entity_directed_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">split_into_independent_clauses</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">extract_ac_asca_vc</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tvc&#39;</span><span class="p">:</span>
            <span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>

            <span class="n">ac_sentiment</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">ac_full_text</span><span class="p">)</span>
            <span class="n">asca_sentiment</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">asca_full_text</span><span class="p">)</span>
            <span class="n">vc_sentiment</span> <span class="o">=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">vc_full_text</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">named_entities_actor</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                    <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">ac_sentiment</span><span class="p">,</span> <span class="n">vc_sentiment</span><span class="p">,</span> <span class="n">asca_sentiment</span><span class="p">)</span>
                <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">named_entities_victim</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                    <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">calculate_compound_sentiment</span><span class="p">(</span><span class="n">vc_sentiment</span><span class="p">,</span> <span class="n">ac_sentiment</span><span class="p">,</span> <span class="n">asca_sentiment</span><span class="p">)</span>
                <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ntvc&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                    <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_sentiment</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
                <span class="n">entities</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid output found.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entities</span><span class="p">,</span> <span class="n">out</span>
</code></pre>
</div>

<p>Now let's give this a try with a variety of sentences:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Adam and Alice ordered John to stop eating in a late-night hateful rant.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;While ranting hatefully, Adam ordered John to stop eating.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adam, a horrible person, ordered John to stop eating.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;John was ordered to stop eating by Adam in a late-night hateful rant.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;While ranting hatefully, John was ordered to stop eating by Adam.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The best road trip in Boston history has given the Celtics a chance at grabbing a piece of NBA history.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The waspâ€™s flaps and teeth-like hairs resemble the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects.&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">texts_new</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Dr. Velnor&#39;s theory was dismissed as absurd by the entire academic panel.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Zantra Corpâ€™s latest device revolutionized clean energy storage overnight.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mayor Ellith of Norbridge failed to respond during the townâ€™s worst flood in decades.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The Lysara Institute continues to produce groundbreaking neuroscience research.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Critics slammed Darven Tech&#39;s flagship phone for its unreliable battery life.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Professor Kezilâ€™s lectures are dry, but his insights are unmatched in the field.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Juno Aeronautics impressed investors with its sleek new drone prototypes.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Velaraâ€™s book on dream logic captivated readers with its haunting prose.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The Norell Foundationâ€™s involvement in the scandal tarnished its spotless reputation.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cylix Entertainment delivered a visually stunning game plagued by technical flaws.&quot;</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Previous texts ---&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">calculate_entity_directed_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- New texts ---&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts_new</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">calculate_entity_directed_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre>
</div>

<pre><code>--- Previous texts ---
Adam and Alice ordered John to stop eating in a late-night hateful rant.
{'type': 'tvc', 'output': ('Adam and Alice in a late - night hateful rant', 'ordered to stop eating .', 'Adam Alice ordered to stop eating .', 'John', ['Adam', 'Alice'], ['John'])}
{'Adam': {'sentiment': -0.5423, 'count': 1}, 'Alice': {'sentiment': -0.5423, 'count': 1}, 'John': {'sentiment': 0.1017048, 'count': 1}}

While ranting hatefully, Adam ordered John to stop eating.
{'type': 'tvc', 'output': ('While ranting hatefully Adam', ', ordered to stop eating .', ', Adam ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.253475, 'count': 1}, 'John': {'sentiment': 0.0778286, 'count': 1}}

Adam, a horrible person, ordered John to stop eating.
{'type': 'tvc', 'output': ('Adam , a horrible person ,', 'ordered to stop eating .', 'Adam ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.49036250000000003, 'count': 1}, 'John': {'sentiment': 0.0974113, 'count': 1}}

John was ordered to stop eating by Adam in a late-night hateful rant.
{'type': 'tvc', 'output': ('by Adam', 'was ordered to stop eating .', 'was ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.062, 'count': 1}, 'John': {'sentiment': -0.062, 'count': 1}}

While ranting hatefully, John was ordered to stop eating by Adam.
{'type': 'tvc', 'output': ('While ranting hatefully by Adam', ', was ordered to stop eating .', ', was ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.253475, 'count': 1}, 'John': {'sentiment': 0.0778286, 'count': 1}}

The best road trip in Boston history has given the Celtics a chance at grabbing a piece of NBA history.
{'type': 'tvc', 'output': ('The best road trip in Boston history', 'has given .', 'trip has given .', 'the Celtics a chance at grabbing a piece of NBA history', ['Boston'], ['Celtics', 'NBA'])}
{'Boston': {'sentiment': 0.46383749999999996, 'count': 1}, 'Celtics': {'sentiment': 0.24375000000000002, 'count': 1}, 'Nba': {'sentiment': 0.24375000000000002, 'count': 1}}

The waspâ€™s flaps and teeth-like hairs resemble the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects.
{'type': 'tvc', 'output': ('The wasp â€™s flaps and teeth - like hairs', 'resemble .', 'hairs resemble .', 'the structure of the carnivorous Venus flytrap plant , which snaps shut to digest unsuspecting insects', [], ['Venus'])}
{'Venus': {'sentiment': 0.0, 'count': 1}}


--- New texts ---
Dr. Velnor's theory was dismissed as absurd by the entire academic panel.
{'type': 'tvc', 'output': ('as absurd', 'was dismissed by .', 'was dismissed by .', "Dr. Velnor 's theory", [], ['Velnor'])}
{'Velnor': {'sentiment': -0.05, 'count': 1}}

Zantra Corpâ€™s latest device revolutionized clean energy storage overnight.
{'type': 'tvc', 'output': ('Zantra Corp â€™s latest device', 'revolutionized overnight .', 'device revolutionized overnight .', 'clean energy storage', ['Zantra Corpâ€™s'], [])}
{'Zantra corpâ€™s': {'sentiment': 0.0, 'count': 1}}

Mayor Ellith of Norbridge failed to respond during the townâ€™s worst flood in decades.
{'type': 'ntvc', 'output': ('Mayor Ellith of Norbridge failed to respond during the townâ€™s worst flood in decades.', '', '', '', ['Ellith', 'Norbridge'], '')}
{'Ellith': {'sentiment': -0.6563, 'count': 1}, 'Norbridge': {'sentiment': -0.6563, 'count': 1}}

The Lysara Institute continues to produce groundbreaking neuroscience research.
{'type': 'tvc', 'output': ('The Lysara Institute', 'continues to produce groundbreaking .', 'Institute continues to produce groundbreaking .', '', ['The Lysara Institute'], [])}
{'The lysara institute': {'sentiment': 0.0, 'count': 1}}

Critics slammed Darven Tech's flagship phone for its unreliable battery life.
{'type': 'tvc', 'output': ('Critics for its unreliable battery life', 'slammed .', 'Critics slammed .', "Darven Tech 's flagship phone", [], ["Darven Tech's"])}
{"Darven tech's": {'sentiment': 0.3057885, 'count': 1}}

Professor Kezilâ€™s lectures are dry, but his insights are unmatched in the field.
{'type': 'ntvc', 'output': ('his insights are unmatched in the field .', '', '', '', [], '')}
{'Kezil': {'sentiment': 0.0, 'count': 1}}

Juno Aeronautics impressed investors with its sleek new drone prototypes.
{'type': 'tvc', 'output': ('Juno Aeronautics with its sleek new drone prototypes', 'impressed .', 'Aeronautics impressed .', 'investors', ['Juno Aeronautics'], [])}
{'Juno aeronautics': {'sentiment': 0.1345875, 'count': 1}}

Velaraâ€™s book on dream logic captivated readers with its haunting prose.
{'type': 'tvc', 'output': ('Velara â€™s book on dream logic with its haunting prose', 'captivated .', 'book captivated .', 'readers', [], [])}
{}

The Norell Foundationâ€™s involvement in the scandal tarnished its spotless reputation.
{'type': 'tvc', 'output': ('The Norell Foundation â€™s involvement in the scandal', 'tarnished .', 'involvement tarnished .', 'its spotless reputation', ['The Norell Foundationâ€™s'], [])}
{'The norell foundationâ€™s': {'sentiment': -0.45015, 'count': 1}}

Cylix Entertainment delivered a visually stunning game plagued by technical flaws.
{'type': 'tvc', 'output': ('Cylix Entertainment', 'delivered .', 'Entertainment delivered .', 'a visually stunning game plagued by technical flaws', ['Cylix Entertainment'], [])}
{'Cylix entertainment': {'sentiment': 0.21905179375, 'count': 1}}

</code></pre>

<p>Interesting. So it seems that right now, the rule-based analysis for prepositions doesn't consider the difference unique to the word "for" as "for" associates an issue with the victim instead of the actor, as is common for most other preps ("Critics slammed Darven Tech's flagship phone for its unreliable battery life." case). Also, for some reason, the entity "Velara" isn't extracted/considered an entity ("Velaraâ€™s book on dream logic captivated readers with its haunting prose." case). Let's try fix this.</p>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">extract_ac_asca_vc</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;dobj&#39;</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubj&quot;</span><span class="p">])</span>
        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dobj&quot;</span><span class="p">])</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_base</span><span class="p">:</span>
            <span class="n">ac_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base_subtree</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;prep&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_prep_tokens_actor</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vc_prep_tokens_victim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_prep_base</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;with&quot;</span><span class="p">]:</span>
                <span class="n">vc_prep_tokens_victim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ac_prep_tokens_actor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_prep_tokens_actor</span><span class="p">:</span>
            <span class="n">ac_prep_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">vc_prep_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_prep_tokens_victim</span><span class="p">:</span>
            <span class="n">vc_prep_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">ac_advcl_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;advcl&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_advcl_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_advcl_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">ac_advcl_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="o">+</span> <span class="n">ac_advcl_base_subtree</span><span class="p">))</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>
        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubj&quot;</span><span class="p">,</span> <span class="s2">&quot;dobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">))</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base</span> <span class="o">+</span> <span class="n">a_full</span><span class="p">))</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>
        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_base</span><span class="p">:</span>
            <span class="n">vc_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dative&quot;</span><span class="p">],</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span> <span class="o">+</span> <span class="n">vc_prep_base_subtree</span><span class="p">))</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>
        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span><span class="p">)}</span>
    <span class="k">elif</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;nsubjpass&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_dependency</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;pobj&#39;</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">get_sentence_root</span><span class="p">(</span><span class="n">doc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ac_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;pobj&quot;</span><span class="p">])</span>
        <span class="n">vc_base</span> <span class="o">=</span> <span class="n">get_subtree_dependents_by_dep</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubjpass&quot;</span><span class="p">])</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_base</span><span class="p">:</span>
            <span class="n">ac_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">ac_base_subtree</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base_subtree</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_prep_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;prep&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_prep_tokens_actor</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vc_prep_tokens_victim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_prep_base</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;with&quot;</span><span class="p">]:</span>
                <span class="n">vc_prep_tokens_victim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ac_prep_tokens_actor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">ac_prep_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_prep_tokens_actor</span><span class="p">:</span>
            <span class="n">ac_prep_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">vc_prep_base_subtree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_prep_tokens_victim</span><span class="p">:</span>
            <span class="n">vc_prep_base_subtree</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_full_subtree</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">ac_advcl_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;advcl&quot;</span><span class="p">],</span> <span class="n">ac_base</span> <span class="o">+</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">ac_advcl_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">ac_advcl_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">ac_advcl_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base_subtree</span> <span class="o">+</span> <span class="n">ac_prep_base_subtree</span> <span class="o">+</span> <span class="n">ac_advcl_base_subtree</span><span class="p">))</span>
        <span class="n">ac_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ac_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ac_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ac_full</span><span class="p">])</span>
        <span class="n">a_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nsubjpass&quot;</span><span class="p">,</span> <span class="s2">&quot;pobj&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;advcl&quot;</span><span class="p">,</span> <span class="s2">&quot;dative&quot;</span><span class="p">])</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a_base_subtree</span><span class="p">))</span>
        <span class="n">a_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">a_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">a_full</span><span class="p">])</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ac_base</span> <span class="o">+</span> <span class="n">a_full</span><span class="p">))</span>
        <span class="n">asca_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">asca_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">asca_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">asca_full</span><span class="p">])</span>
        <span class="n">vc_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vc_dative_base</span> <span class="o">=</span> <span class="n">get_tokens_dep_excluding_subtrees</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dative&quot;</span><span class="p">],</span> <span class="n">vc_base</span><span class="p">)</span>
        <span class="n">vc_dative_base_subtree</span> <span class="o">=</span> <span class="n">get_full_subtree</span><span class="p">(</span><span class="n">vc_dative_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">vc_dative_base</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vc_base_subtree</span> <span class="o">+</span> <span class="n">vc_dative_base_subtree</span> <span class="o">+</span> <span class="n">vc_prep_base_subtree</span><span class="p">))</span>
        <span class="n">vc_full</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_full</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">vc_full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vc_full</span><span class="p">])</span>
        <span class="n">named_entities_actor</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">ac_full</span><span class="p">)</span>
        <span class="n">named_entities_victim</span> <span class="o">=</span> <span class="n">extract_named_entities_token</span><span class="p">(</span><span class="n">vc_full</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ac_full_text</span><span class="p">,</span> <span class="n">a_full_text</span><span class="p">,</span> <span class="n">asca_full_text</span><span class="p">,</span> <span class="n">vc_full_text</span><span class="p">,</span> <span class="n">named_entities_actor</span><span class="p">,</span> <span class="n">named_entities_victim</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ntvc&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">extract_named_entities</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
</code></pre>
</div>

<p>Alright, with that fixed: let's test one more time:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Adam and Alice ordered John to stop eating in a late-night hateful rant.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;While ranting hatefully, Adam ordered John to stop eating.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adam, a horrible person, ordered John to stop eating.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;John was ordered to stop eating by Adam in a late-night hateful rant.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;While ranting hatefully, John was ordered to stop eating by Adam.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The best road trip in Boston history has given the Celtics a chance at grabbing a piece of NBA history.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The waspâ€™s flaps and teeth-like hairs resemble the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects.&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">texts_new</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Dr. Velnor&#39;s theory was dismissed as absurd by the entire academic panel.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Zantra Corpâ€™s latest device revolutionized clean energy storage overnight.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mayor Ellith of Norbridge failed to respond during the townâ€™s worst flood in decades.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The Lysara Institute continues to produce groundbreaking neuroscience research.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Critics slammed Darven Tech&#39;s flagship phone for its unreliable battery life.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Professor Kezilâ€™s lectures are dry, but his insights are unmatched in the field.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Juno Aeronautics impressed investors with its sleek new drone prototypes.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Velaraâ€™s book on dream logic captivated readers with its haunting prose.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;The Norell Foundationâ€™s involvement in the scandal tarnished its spotless reputation.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cylix Entertainment delivered a visually stunning game plagued by technical flaws.&quot;</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Previous texts ---&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">calculate_entity_directed_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- New texts ---&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts_new</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">calculate_entity_directed_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre>
</div>

<pre><code>--- Previous texts ---
Adam and Alice ordered John to stop eating in a late-night hateful rant.
{'type': 'tvc', 'output': ('Adam and Alice in a late - night hateful rant', 'ordered to stop eating .', 'Adam Alice ordered to stop eating .', 'John', ['Adam', 'Alice'], ['John'])}
{'Adam': {'sentiment': -0.5423, 'count': 1}, 'Alice': {'sentiment': -0.5423, 'count': 1}, 'John': {'sentiment': 0.1017048, 'count': 1}}

While ranting hatefully, Adam ordered John to stop eating.
{'type': 'tvc', 'output': ('While ranting hatefully Adam', ', ordered to stop eating .', ', Adam ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.253475, 'count': 1}, 'John': {'sentiment': 0.0778286, 'count': 1}}

Adam, a horrible person, ordered John to stop eating.
{'type': 'tvc', 'output': ('Adam , a horrible person ,', 'ordered to stop eating .', 'Adam ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.49036250000000003, 'count': 1}, 'John': {'sentiment': 0.0974113, 'count': 1}}

John was ordered to stop eating by Adam in a late-night hateful rant.
{'type': 'tvc', 'output': ('by Adam in a late - night hateful rant', 'was ordered to stop eating .', 'was ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.5423, 'count': 1}, 'John': {'sentiment': 0.1017048, 'count': 1}}

While ranting hatefully, John was ordered to stop eating by Adam.
{'type': 'tvc', 'output': ('While ranting hatefully by Adam', ', was ordered to stop eating .', ', was ordered to stop eating .', 'John', ['Adam'], ['John'])}
{'Adam': {'sentiment': -0.253475, 'count': 1}, 'John': {'sentiment': 0.0778286, 'count': 1}}

The best road trip in Boston history has given the Celtics a chance at grabbing a piece of NBA history.
{'type': 'tvc', 'output': ('The best road trip in Boston history', 'has given .', 'trip has given .', 'the Celtics a chance at grabbing a piece of NBA history', ['Boston'], ['Celtics', 'NBA'])}
{'Boston': {'sentiment': 0.46383749999999996, 'count': 1}, 'Celtics': {'sentiment': 0.24375000000000002, 'count': 1}, 'Nba': {'sentiment': 0.24375000000000002, 'count': 1}}

The waspâ€™s flaps and teeth-like hairs resemble the structure of the carnivorous Venus flytrap plant, which snaps shut to digest unsuspecting insects.
{'type': 'tvc', 'output': ('The wasp â€™s flaps and teeth - like hairs', 'resemble .', 'hairs resemble .', 'the structure of the carnivorous Venus flytrap plant , which snaps shut to digest unsuspecting insects', [], ['Venus'])}
{'Venus': {'sentiment': 0.0, 'count': 1}}


--- New texts ---
Dr. Velnor's theory was dismissed as absurd by the entire academic panel.
{'type': 'tvc', 'output': ('as absurd', 'was dismissed by .', 'was dismissed by .', "Dr. Velnor 's theory", [], ['Velnor'])}
{'Velnor': {'sentiment': -0.05, 'count': 1}}

Zantra Corpâ€™s latest device revolutionized clean energy storage overnight.
{'type': 'tvc', 'output': ('Zantra Corp â€™s latest device', 'revolutionized overnight .', 'device revolutionized overnight .', 'clean energy storage', ['Zantra Corpâ€™s'], [])}
{'Zantra corpâ€™s': {'sentiment': 0.0, 'count': 1}}

Mayor Ellith of Norbridge failed to respond during the townâ€™s worst flood in decades.
{'type': 'ntvc', 'output': ('Mayor Ellith of Norbridge failed to respond during the townâ€™s worst flood in decades.', '', '', '', ['Ellith', 'Norbridge'], '')}
{'Ellith': {'sentiment': -0.6563, 'count': 1}, 'Norbridge': {'sentiment': -0.6563, 'count': 1}}

The Lysara Institute continues to produce groundbreaking neuroscience research.
{'type': 'tvc', 'output': ('The Lysara Institute', 'continues to produce groundbreaking .', 'Institute continues to produce groundbreaking .', '', ['The Lysara Institute'], [])}
{'The lysara institute': {'sentiment': 0.0, 'count': 1}}

Critics slammed Darven Tech's flagship phone for its unreliable battery life.
{'type': 'tvc', 'output': ('Critics', 'slammed .', 'Critics slammed .', "Darven Tech 's flagship phone for its unreliable battery life", [], ["Darven Tech's"])}
{"Darven tech's": {'sentiment': 0.3057885, 'count': 1}}

Professor Kezilâ€™s lectures are dry, but his insights are unmatched in the field.
{'type': 'ntvc', 'output': ('his insights are unmatched in the field .', '', '', '', [], '')}
{'Kezil': {'sentiment': 0.0, 'count': 1}}

Juno Aeronautics impressed investors with its sleek new drone prototypes.
{'type': 'tvc', 'output': ('Juno Aeronautics', 'impressed .', 'Aeronautics impressed .', 'investors with its sleek new drone prototypes', ['Juno Aeronautics'], [])}
{'Juno aeronautics': {'sentiment': 0.1345875, 'count': 1}}

Velaraâ€™s book on dream logic captivated readers with its haunting prose.
{'type': 'tvc', 'output': ('Velara â€™s book on dream logic', 'captivated .', 'book captivated .', 'readers with its haunting prose', [], [])}
{}

The Norell Foundationâ€™s involvement in the scandal tarnished its spotless reputation.
{'type': 'tvc', 'output': ('The Norell Foundation â€™s involvement in the scandal', 'tarnished .', 'involvement tarnished .', 'its spotless reputation', ['The Norell Foundationâ€™s'], [])}
{'The norell foundationâ€™s': {'sentiment': -0.45015, 'count': 1}}

Cylix Entertainment delivered a visually stunning game plagued by technical flaws.
{'type': 'tvc', 'output': ('Cylix Entertainment', 'delivered .', 'Entertainment delivered .', 'a visually stunning game plagued by technical flaws', ['Cylix Entertainment'], [])}
{'Cylix entertainment': {'sentiment': 0.21905179375, 'count': 1}}

</code></pre>

<p>Well, that is much better, though it seems Velara is just not considered a named enitity and "flagship" is considered positive while "unreliable" is not. Other than that though, I'm really satisfied with how this project turned out! It seems to handle texts very well for it being rule based. While further things need to be tested, for now, I'd say it's good enough. </p>

<p>Just to list a few of my future goals:</p>

<ul>
<li>Build a structure that makes adding new conditions very easy</li>
<li>Refine and consider how most sentences are structured
<ul>
<li>For instance: Negative statements ("Adam did not fight John")</li>
<li>Discourse-level sentiment ambiguity (Short phrases in conversation like: "Adam? He was bad.")</li>
<li>No distinction for quoted entities</li>
</ul></li>
<li>Refine the sentiment calculations and tools</li>
</ul>

<p>All in all though, I'm pretty satisfied with this first start.</p>

<p>Cheers!</p>
</div></div>    </main>

    <footer class="site-footer">
        <div class="container">
            &copy; 2025 Harry Yin. All rights reserved.
            <p class="text-muted mt-xs">Powered by SiteGen</p>
        </div>
    </footer>

    <script src="/static/js/main.js"></script>
</body>
</html>